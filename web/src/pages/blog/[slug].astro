---
import Base from '../../layouts/Base.astro'
import {sanityClient} from 'sanity:client'
import {marked} from 'marked'
import {PortableText} from 'astro-portabletext'
import {postQuery, postsQuery, urlFor, readingTime} from '../../utils/sanity'

export async function getStaticPaths() {
  const posts = await sanityClient.fetch(postsQuery)
  return posts.map((post: any) => ({
    params: {slug: post.slug.current},
  }))
}

const {slug} = Astro.params
const post = await sanityClient.fetch(postQuery, {slug})

if (!post) {
  return Astro.redirect('/404')
}

const isMarkdown = typeof post.body === 'string'
const htmlBody = isMarkdown ? marked(post.body) : null
const minRead = readingTime(post.body)
---

<Base title={`${post.title} - waglesworld`}>
  <article>
    <header>
      <h1>{post.title}</h1>
      <div class="meta">
        {
          post.author && (
            <span class="author">
              {post.author.image && (
                <img
                  src={urlFor(post.author.image).width(32).height(32).url()}
                  alt={post.author.name}
                  class="author-img"
                />
              )}
              {post.author.name}
            </span>
          )
        }
        {
          post.publishedAt && (
            <time datetime={post.publishedAt}>
              {new Date(post.publishedAt).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })}
            </time>
          )
        }
        <span>{minRead} min read</span>
      </div>
      {
        post.tags && post.tags.length > 0 && (
          <div class="tags">
            {post.tags.map((tag: string) => (
              <span class="tag">{tag}</span>
            ))}
          </div>
        )
      }
    </header>

    {
      post.mainImage && (
        <img
          src={urlFor(post.mainImage).width(720).url()}
          alt={post.title}
          class="hero-image"
        />
      )
    }

    <div class="body">
      {post.body && isMarkdown && <Fragment set:html={htmlBody} />}
      {post.body && !isMarkdown && <PortableText value={post.body} />}
    </div>
  </article>

  <a href="/blog" class="back">&larr; Back to blog</a>

  <section class="subscribe">
    <p>Enjoyed this post? Get new ones in your inbox.</p>
    <form class="subscribe-form" data-kit-form>
      <input type="email" name="email_address" placeholder="your@email.com" required />
      <button type="submit">Subscribe</button>
    </form>
    <p class="subscribe-success" style="display:none;">Thanks! Check your email to confirm.</p>
    <p class="rss-link">Or subscribe via <a href="/rss.xml">RSS</a></p>
  </section>
  <script is:inline>
    document.querySelectorAll('[data-kit-form]').forEach(function(form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        var email = form.querySelector('input[name="email_address"]').value;
        var btn = form.querySelector('button');
        btn.textContent = 'Subscribing...';
        btn.disabled = true;
        fetch('https://api.convertkit.com/v3/forms/9065996/subscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json; charset=utf-8'
          },
          body: JSON.stringify({api_key: '2oEXnmtRQKcj-qQEXCNx-g', email: email})
        }).then(function(res) {
          if (res.ok || res.status === 200 || res.status === 201) {
            form.style.display = 'none';
            form.nextElementSibling.style.display = 'block';
          } else {
            throw new Error('Subscription failed');
          }
        }).catch(function() {
          btn.textContent = 'Subscribe';
          btn.disabled = false;
          window.open('https://waglesworld.kit.com/a1f891a000', '_blank');
        });
      });
    });
  </script>

  <section class="comments">
    <script
      src="https://giscus.app/client.js"
      data-repo="mavaali/waglesworld"
      data-repo-id="R_kgDORLJ8TQ"
      data-category="General"
      data-category-id="DIC_kwDORLJ8Tc4C2CHX"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="light"
      data-lang="en"
      data-loading="lazy"
      crossorigin="anonymous"
      async
    ></script>
  </section>
</Base>

<style>
  article header {
    margin-bottom: 2rem;
  }

  .meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    color: #666;
    font-size: 0.875rem;
    margin-top: 0.5rem;
  }

  .author {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .author-img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
  }

  .tags {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }

  .tag {
    background: #f0f0f0;
    padding: 0.15rem 0.5rem;
    border-radius: 3px;
    font-size: 0.8rem;
    color: #555;
  }

  .hero-image {
    width: 100%;
    margin-bottom: 2rem;
  }

  .body {
    font-size: 1.05rem;
    line-height: 1.8;
  }

  .body :global(p) {
    margin-bottom: 1.25rem;
  }

  .body :global(h2) {
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .body :global(h3) {
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .body :global(blockquote) {
    border-left: 3px solid #ddd;
    padding-left: 1rem;
    color: #555;
    margin: 1.5rem 0;
  }

  .body :global(ul),
  .body :global(ol) {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
  }

  .body :global(img) {
    margin: 1.5rem 0;
  }

  .body :global(a) {
    color: #0066cc;
    text-decoration: underline;
  }

  .back {
    display: inline-block;
    margin-top: 3rem;
    color: #666;
    font-size: 0.875rem;
  }

  .subscribe {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
  }

  .subscribe p {
    color: #666;
    margin-bottom: 1rem;
  }

  .subscribe-form {
    display: flex;
    gap: 0.5rem;
  }

  .subscribe-form input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.95rem;
    font-family: inherit;
  }

  .subscribe-form button {
    padding: 0.5rem 1.25rem;
    background: #1a1a1a;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 0.95rem;
    font-family: inherit;
    cursor: pointer;
  }

  .subscribe-form button:hover {
    background: #333;
  }

  .rss-link {
    font-size: 0.8rem;
    margin-top: 0.5rem;
  }

  .rss-link a {
    color: #0066cc;
    text-decoration: underline;
  }

  .comments {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
  }
</style>
