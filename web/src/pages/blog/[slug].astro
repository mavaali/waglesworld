---
import Base from '../../layouts/Base.astro'
import {sanityClient} from 'sanity:client'
import {marked} from 'marked'
import markedKatex from 'marked-katex-extension'

marked.use(markedKatex({throwOnError: false}))
import {PortableText} from 'astro-portabletext'
import groq from 'groq'
import {postQuery, postsQuery, urlFor, readingTime, excerpt} from '../../utils/sanity'

export async function getStaticPaths() {
  const posts = await sanityClient.fetch(postsQuery)
  return posts.map((post: any) => ({
    params: {slug: post.slug.current},
  }))
}

const {slug} = Astro.params
const post = await sanityClient.fetch(postQuery, {slug})

if (!post) {
  return Astro.redirect('/404')
}

const isMarkdown = typeof post.body === 'string'
const htmlBody = isMarkdown ? marked(post.body) : null
const minRead = readingTime(post.body)
const postDescription = excerpt(post.body)
const postImage = post.mainImage ? urlFor(post.mainImage).width(1200).url() : undefined
const postUrl = new URL(`/blog/${post.slug.current}/`, Astro.site).href

const relatedPosts = post.tags?.length
  ? await sanityClient.fetch(
      groq`*[_type == "post" && slug.current != $slug && count(tags[@ in $tags]) > 0] | order(publishedAt desc) [0...3] {
        title,
        slug,
        publishedAt,
        tags
      }`,
      {slug, tags: post.tags}
    )
  : []

const jsonLd = JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: post.title,
  description: postDescription,
  author: {
    '@type': 'Person',
    name: post.author?.name || 'Mihir Wagle',
    url: 'https://waglesworld.com/about',
    sameAs: [
      'https://www.linkedin.com/in/mihirwagle/',
      'https://github.com/mavaali',
    ],
  },
  datePublished: post.publishedAt,
  url: postUrl,
  publisher: {
    '@type': 'Person',
    name: 'Mihir Wagle',
    url: 'https://waglesworld.com',
  },
  ...(postImage && {image: postImage}),
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': postUrl,
  },
})
---

<Base title={`${post.title} - waglesworld`} description={postDescription} image={postImage} type="article">
  <script type="application/ld+json" set:html={jsonLd} />
  <article>
    <header>
      <h1>{post.title}</h1>
      <div class="meta">
        {
          post.author && (
            <span class="author">
              {post.author.image && (
                <img
                  src={urlFor(post.author.image).width(32).height(32).url()}
                  alt={post.author.name}
                  class="author-img"
                />
              )}
              {post.author.name}
            </span>
          )
        }
        {
          post.publishedAt && (
            <time datetime={post.publishedAt}>
              {new Date(post.publishedAt).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })}
            </time>
          )
        }
        <span>{minRead} min read</span>
      </div>
      {
        post.tags && post.tags.length > 0 && (
          <div class="tags">
            {post.tags.map((tag: string) => (
              <span class="tag">{tag}</span>
            ))}
          </div>
        )
      }
    </header>

    {
      post.mainImage && (
        <img
          src={urlFor(post.mainImage).width(720).url()}
          alt={post.title}
          class="hero-image"
        />
      )
    }

    <div class="body">
      {post.body && isMarkdown && <Fragment set:html={htmlBody} />}
      {post.body && !isMarkdown && <PortableText value={post.body} />}
    </div>
  </article>

  <a href="/blog" class="back">&larr; Back to blog</a>

  <section class="subscribe">
    <p>Enjoyed this post? Get new ones in your inbox.</p>
    <form class="subscribe-form" action="https://app.kit.com/forms/9065996/subscriptions" method="post" data-sv-form="9065996" data-uid="a1f891a000" data-format="inline" target="_blank">
      <input type="email" name="email_address" placeholder="your@email.com" required />
      <button type="submit">Subscribe</button>
    </form>
    <p class="rss-link">Or subscribe via <a href="/rss.xml">RSS</a></p>
  </section>

  {relatedPosts.length > 0 && (
    <section class="related">
      <h2>Related Posts</h2>
      <ul>
        {relatedPosts.map((rp: any) => (
          <li>
            <a href={`/blog/${rp.slug.current}/`}>{rp.title}</a>
            {rp.publishedAt && (
              <time datetime={rp.publishedAt}>
                {new Date(rp.publishedAt).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric',
                })}
              </time>
            )}
          </li>
        ))}
      </ul>
    </section>
  )}

  <section class="comments">
    <script
      src="https://giscus.app/client.js"
      data-repo="mavaali/waglesworld"
      data-repo-id="R_kgDORLJ8TQ"
      data-category="General"
      data-category-id="DIC_kwDORLJ8Tc4C2CHX"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="light"
      data-lang="en"
      data-loading="lazy"
      crossorigin="anonymous"
      async
    ></script>
  </section>
</Base>

<style>
  article header {
    margin-bottom: 2rem;
  }

  .meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    color: #666;
    font-size: 0.875rem;
    margin-top: 0.5rem;
  }

  .author {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .author-img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
  }

  .tags {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }

  .tag {
    background: #f0f0f0;
    padding: 0.15rem 0.5rem;
    border-radius: 3px;
    font-size: 0.8rem;
    color: #555;
  }

  .hero-image {
    width: 100%;
    margin-bottom: 2rem;
  }

  .body {
    font-size: 1.05rem;
    line-height: 1.8;
  }

  .body :global(p) {
    margin-bottom: 1.25rem;
  }

  .body :global(h2) {
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .body :global(h3) {
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .body :global(blockquote) {
    border-left: 3px solid #ddd;
    padding-left: 1rem;
    color: #555;
    margin: 1.5rem 0;
  }

  .body :global(ul),
  .body :global(ol) {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
  }

  .body :global(img) {
    margin: 1.5rem 0;
  }

  .body :global(a) {
    color: #0066cc;
    text-decoration: underline;
  }

  .back {
    display: inline-block;
    margin-top: 3rem;
    color: #666;
    font-size: 0.875rem;
  }

  .subscribe {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
  }

  .subscribe p {
    color: #666;
    margin-bottom: 1rem;
  }

  .subscribe-form {
    display: flex;
    gap: 0.5rem;
  }

  .subscribe-form input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.95rem;
    font-family: inherit;
  }

  .subscribe-form button {
    padding: 0.5rem 1.25rem;
    background: #1a1a1a;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 0.95rem;
    font-family: inherit;
    cursor: pointer;
  }

  .subscribe-form button:hover {
    background: #333;
  }

  .rss-link {
    font-size: 0.8rem;
    margin-top: 0.5rem;
  }

  .rss-link a {
    color: #0066cc;
    text-decoration: underline;
  }

  .related {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
  }

  .related h2 {
    font-size: 1.25rem;
    margin-bottom: 1rem;
  }

  .related ul {
    list-style: none;
    padding: 0;
  }

  .related li {
    margin-bottom: 0.75rem;
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 1rem;
  }

  .related a {
    color: #0066cc;
    text-decoration: underline;
  }

  .related time {
    color: #999;
    font-size: 0.8rem;
    white-space: nowrap;
  }

  .comments {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
  }
</style>
